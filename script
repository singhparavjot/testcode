# Connect to your Azure account
Connect-AzAccount

# Define the Resource Group and VM names
$resourceGroupName = "<YourResourceGroupName>"
$vmList = Get-AzVM -ResourceGroupName $resourceGroupName

# Define the time range for the metrics (last 30 days)
$endTime = Get-Date
$startTime = $endTime.AddDays(-30)

# Initialize an array to hold the report data
$report = @()

foreach ($vm in $vmList) {
    # Get the VM details
    $vmName = $vm.Name
    $osType = $vm.StorageProfile.OsDisk.OsType
    $sku = $vm.HardwareProfile.VmSize

    # Get CPU utilization metrics
    $cpuMetrics = Get-AzMetric -ResourceId $vm.Id -MetricName "Percentage CPU" -StartTime $startTime -EndTime $endTime -AggregationType Average
    $averageCpuUtilization = $cpuMetrics.Data.Average

    # Get the monthly cost (approximation)
    $vmCost = (Get-UsageAggregates -ReportedStartTime $startTime -ReportedEndTime $endTime -ShowDetails $true).UsageAggregations |
              Where-Object { $_.InstanceData.MeteredResourceID -like "*$($vm.Id)*" } |
              Measure-Object -Sum -Property PretaxCost | Select-Object -ExpandProperty Sum

    # Add the VM details to the report
    $report += [PSCustomObject]@{
        VMName           = $vmName
        OS               = $osType
        SKU              = $sku
        AvgCpuUtilization = [math]::round($averageCpuUtilization, 2)
        MonthlyCost      = [math]::round($vmCost, 2)
    }
}

# Export the report to a CSV file
$report | Export-Csv -Path "C:\path\to\your\vm_report.csv" -NoTypeInformation

Write-Host "VM report generated successfully at C:\path\to\your\vm_report.csv"
